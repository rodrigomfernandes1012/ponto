<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dados do Banco</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        function filterTable() {
            let table = document.getElementById("dataTable");
            let tr = table.getElementsByTagName("tr");
            let filters = [];

            for (let i = 0; i < table.rows[1].cells.length; i++) {
                let input = document.getElementById("filter" + i);
                filters.push(input.value.toLowerCase());
            }

            for (let i = 2; i < tr.length; i++) {
                let tds = tr[i].getElementsByTagName("td");
                let rowMatchesFilter = true;

                for (let j = 0; j < tds.length; j++) {
                    if (tds[j]) {
                        let txtValue = tds[j].textContent || tds[j].innerText;
                        if (filters[j] && !txtValue.toLowerCase().includes(filters[j])) {
                            rowMatchesFilter = false;
                        }
                    }
                }
                tr[i].style.display = rowMatchesFilter ? "" : "none";
            }
        }

        async function exportToExcel() {
            let table = document.getElementById("dataTable");
            let rows = Array.from(table.getElementsByTagName("tr")).slice(2); // Pulo o cabeçalho e a linha de filtros
            let data = rows.map(tr => {
                let cells = Array.from(tr.getElementsByTagName("td"));
                return {
                    dsId: cells[0].innerText,
                    nrLinha: cells[1].innerText,
                    dsCodigoItem: cells[2].innerText,
                    dsDescricao: cells[3].innerText,
                    dsUnidade: cells[4].innerText,
                    dsCodigoLote: cells[5].innerText,
                    dsQuantidade: cells[6].innerText,
                    nrVlunitario: cells[7].innerText,
                    nrVlTotal: cells[8].innerText,
                    nrQAtendida: cells[9].innerText,
                    nrQpendente: cells[10].innerText,
                    bFracionaLinha: cells[11].innerText,
                    nrExpedicaoOld: cells[12].innerText,
                    dsLoteImportacao: cells[13].innerText,
                    dsLoteFabrica: cells[14].innerText
                };
            });

            const response = await fetch('/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ dados: data })
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'dados.xlsx'; // Nome do arquivo a ser baixado
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } else {
                alert('Erro ao exportar os dados');
            }
        }
         function goToPlanilha() {
            window.location.href = '/upload';
        }
    </script>
</head>
<body>
    <div class="container">
        <button onclick="goToPlanilha()" class="nav-btn">Voltar</button>

        <button onclick="exportToExcel();">Exportar para Excel</button>
        <table class="data-table" id="dataTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Linha</th>
                    <th>Código do Item</th>
                    <th>Descrição</th>
                    <th>Unidade</th>
                    <th>Código do Lote</th>
                    <th>Quantidade</th>
                    <th>Valor Unitário</th>
                    <th>Valor Total</th>
                    <th>Quantidade Atendida</th>
                    <th>Quantidade Pendente</th>
                    <th>Fraciona Linha</th>
                    <th>Expedição Antiga</th>
                    <th>Lote de Importação</th>
                    <th>Lote de Fábrica</th>
                </tr>
                <tr>
                    {% for i in range(15) %}
                    <th>
                        <input type="text" id="filter{{ i }}" onkeyup="filterTable()" placeholder="Filtrar...">
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for dado in dados %}
                <tr>
                    <td>{{ dado.dsId }}</td>
                    <td>{{ dado.nrLinha }}</td>
                    <td>{{ dado.dsCodigoItem }}</td>
                    <td>{{ dado.dsDescricao }}</td>
                    <td>{{ dado.dsUnidade }}</td>
                    <td>{{ dado.dsCodigoLote }}</td>
                    <td>{{ dado.dsQuantidade }}</td>
                    <td>{{ dado.nrVlunitario }}</td>
                    <td>{{ dado.nrVlTotal }}</td>
                    <td>{{ dado.nrQAtendida }}</td>
                    <td>{{ dado.nrQpendente }}</td>
                    <td>{{ dado.bFracionaLinha }}</td>
                    <td>{{ dado.nrExpedicaoOld }}</td>
                    <td>{{ dado.dsLoteImportacao }}</td>
                    <td>{{ dado.dsLoteFabrica }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</body>
</html>
